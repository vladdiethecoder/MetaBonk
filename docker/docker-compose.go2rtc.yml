services:
  go2rtc:
    image: "${METABONK_GO2RTC_IMAGE:-alexxit/go2rtc:latest}"
    container_name: "${METABONK_GO2RTC_CONTAINER:-metabonk-go2rtc}"
    restart: unless-stopped

    # WebRTC works best with host networking so ICE candidates match the browser's
    # reachable IP/ports (Docker NAT can break connectivity).
    network_mode: host

    volumes:
      # Config is generated by scripts/start.py (or manually by scripts/go2rtc_generate_config.py).
      # NOTE: defaults are relative to this compose file (docker/), so use ../temp.
      - "${METABONK_GO2RTC_CONFIG:-../temp/go2rtc.yaml}:/config/go2rtc.yaml:ro,Z"
      # FIFO directory (read-only). FIFOs are created on the host.
      - "${METABONK_STREAM_FIFO_DIR:-../temp/streams}:/streams:ro,Z"

    # Explicitly include the binary name; overriding command with only args breaks the image entrypoint.
    command: ["go2rtc", "-config", "/config/go2rtc.yaml"]

    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:1984/', timeout=1).read(1)"]
      interval: 5s
      timeout: 2s
      retries: 12
