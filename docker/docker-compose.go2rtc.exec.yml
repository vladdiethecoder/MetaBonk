services:
  go2rtc:
    build:
      context: ..
      dockerfile: docker/go2rtc.exec.Dockerfile
    image: "${METABONK_GO2RTC_IMAGE:-metabonk-go2rtc-exec:latest}"
    container_name: "${METABONK_GO2RTC_CONTAINER:-metabonk-go2rtc-exec}"
    restart: unless-stopped

    # Optional: allow exec-mode sources to use NVIDIA GPU (NVENC/EGL) inside the container.
    # Requires NVIDIA Container Toolkit on the host.
    device_requests:
      - driver: nvidia
        count: all
        capabilities: [gpu, video, compute, utility, graphics]
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility,graphics

    # WebRTC works best with host networking so ICE candidates match the browser's
    # reachable IP/ports (Docker NAT can break connectivity).
    network_mode: host

    volumes:
      # Mount repo for exec-mode commands (python scripts, wrappers).
      - "${METABONK_REPO_ROOT:-..}:/app:ro"
      # Config is generated by scripts/start.py (or manually by scripts/go2rtc_generate_config.py).
      # NOTE: defaults are relative to this compose file (docker/), so use ../temp.
      - "${METABONK_GO2RTC_CONFIG:-../temp/go2rtc.yaml}:/config/go2rtc.yaml:ro,Z"
      # FIFO directory (read-only). FIFOs are created on the host.
      - "${METABONK_STREAM_FIFO_DIR:-../temp/streams}:/streams:ro,Z"

    working_dir: /app

    # Explicitly include the binary name; overriding command with only args breaks the image entrypoint.
    command: ["go2rtc", "-config", "/config/go2rtc.yaml"]

    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:1984/', timeout=1).read(1)"]
      interval: 5s
      timeout: 2s
      retries: 12
