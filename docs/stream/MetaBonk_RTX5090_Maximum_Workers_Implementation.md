# MetaBonk RTX 5090 “Maximum Workers” (Practical Guide)

## What you can actually optimize

MetaBonk is GPU-only for training/frames. On GeForce-class GPUs (including RTX 5090), **NVENC has a low concurrent session cap** (often ~2).

That means you must choose what “maximum” means:

- **Max training workers (GPU-only)**: run 12–16 workers, but only a couple of concurrent live tiles can stream at once (NVENC-limited).
- **Max concurrent live tiles (viewer-focused)**: enable go2rtc/WebRTC and allow *software encoder fallback for overflow streams* (higher CPU usage).

The repo already includes go2rtc + WebRTC UI + stream profiles; you should not need to write new scripts.

## Current implementation in this repo

- go2rtc is started by the launchers when enabled (`scripts/start.py`, `scripts/start_omega.py`).
- go2rtc config is generated by `scripts/go2rtc_generate_config.py` into `temp/go2rtc.yaml`.
- Worker-to-go2rtc transport is **demand-paged FIFO** (only streams that have viewers consume encoder resources).
- Dashboard playback uses go2rtc WebRTC (`src/frontend/src/components/Go2rtcWebRTC.tsx`).
- NVENC thrash prevention exists, with an opt-in for software fallback:
  - Strict: `METABONK_NVENC_MAX_SESSIONS>0` and `METABONK_STREAM_ALLOW_CPU_FALLBACK=0` (default in `prod`)
  - Viewer-focused: `METABONK_STREAM_ALLOW_CPU_FALLBACK=1` (profile `rtx5090_webrtc_8`)

## Quick start (12 workers)

### Mode A: GPU-only streaming (NVENC-limited, low CPU)
This is the “maximize training” mode. Expect only ~2 live tiles concurrently; others may return HTTP 503 when asked to stream.

```bash
METABONK_WORKER_SPAWN_STAGGER_S=1.0 \
./start --mode train --workers 12 --go2rtc --stream-profile prod --gamescope-width 1280 --gamescope-height 720
```

### Mode B: Many concurrent tiles (WebRTC + software fallback for overflow)
This is the “watch many workers at once” mode. Expect higher CPU usage when many tiles are open simultaneously.

```bash
METABONK_WORKER_SPAWN_STAGGER_S=1.0 \
./start --mode train --workers 12 --go2rtc --stream-profile rtx5090_webrtc_8 --gamescope-width 1280 --gamescope-height 720
```

Open: `http://127.0.0.1:5173/neural/broadcast`

## Validation

```bash
python scripts/nvenc_status.py --workers 12
curl -s http://127.0.0.1:1984/api/streams | jq 'keys | length'
python docs/stream/validate_deployment.py --orch-url http://127.0.0.1:8040 --ui-url http://127.0.0.1:5173
```

## Troubleshooting

- “undefined volume temp/streams”: you are using the wrong compose file; MetaBonk uses `docker/docker-compose.go2rtc.yml` (bind mounts).
- Lots of HTTP 503 streams in Mode A: expected (NVENC cap). Use fewer tiles, or Mode B.
- CPU pegged in Mode B: reduce `METABONK_STREAM_BITRATE`, `METABONK_STREAM_FPS`, or open fewer tiles.
- Mass-restart stream flapping: increase `METABONK_WORKER_SPAWN_STAGGER_S` (e.g., `1.0`–`2.0`).

